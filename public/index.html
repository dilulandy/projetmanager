<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®ä¸äººå‘˜ç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa; padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #2c3e50; margin-bottom: 24px; font-size: 26px; }

        /* æ ‡ç­¾é¡µ */
        .tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 2px solid #e0e6ed; }
        .tab {
            padding: 10px 22px; background: none; border: none; color: #606266;
            cursor: pointer; font-size: 15px; border-bottom: 3px solid transparent;
            margin-bottom: -2px; transition: all 0.2s;
        }
        .tab:hover { color: #409eff; }
        .tab.active { color: #409eff; border-bottom-color: #409eff; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* å¡ç‰‡ */
        .card {
            background: white; border-radius: 8px; padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px;
        }
        .card-title { font-size: 18px; font-weight: 600; color: #303133; margin-bottom: 20px; }

        /* è¡¨å• */
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 18px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full { grid-column: 1 / -1; }
        label { margin-bottom: 6px; color: #303133; font-weight: 500; font-size: 14px; }
        input, select, textarea {
            padding: 9px 11px; border: 1px solid #dcdfe6; border-radius: 4px;
            font-size: 14px; transition: border-color 0.2s; font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #409eff; }
        textarea { resize: vertical; min-height: 80px; }
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23606266' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center;
            background-size: 12px; padding-right: 30px;
            appearance: none; -webkit-appearance: none;
        }

        /* æŒ‰é’® */
        .btn {
            padding: 9px 18px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;
        }
        .btn-primary { background: #409eff; color: white; }
        .btn-primary:hover { background: #66b1ff; }
        .btn-secondary { background: #e4e7ed; color: #606266; }
        .btn-secondary:hover { background: #d3d4d6; }
        .btn-danger { background: #f56c6c; color: white; padding: 5px 11px; font-size: 13px; }
        .btn-danger:hover { background: #f78989; }
        .btn-edit { background: #409eff; color: white; padding: 5px 11px; font-size: 13px; margin-right: 5px; }
        .btn-edit:hover { background: #66b1ff; }

        /* çŠ¶æ€æ ‡ç­¾ */
        .badge {
            display: inline-block; padding: 3px 10px; border-radius: 10px;
            font-size: 12px; font-weight: 500; white-space: nowrap;
        }
        .badge-executing { background: #67c23a; color: white; }
        .badge-high { background: #e6a23c; color: white; }
        .badge-low { background: #909399; color: white; }

        /* è¡¨æ ¼ */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 11px 12px; text-align: left; border-bottom: 1px solid #ebeef5; font-size: 14px; }
        th {
            background: #f5f7fa; color: #606266; font-weight: 600;
            white-space: nowrap; user-select: none;
        }
        th.sortable { cursor: pointer; }
        th.sortable:hover { color: #409eff; }
        th .sort-icon { margin-left: 4px; color: #c0c4cc; font-size: 12px; }
        th.sort-asc .sort-icon, th.sort-desc .sort-icon { color: #409eff; }
        tr:hover td { background: #f5f7fa; }

        /* è‡ªå®šä¹‰å¤šé€‰æ¡† */
        .multiselect { position: relative; }
        .ms-display {
            padding: 9px 11px; border: 1px solid #dcdfe6; border-radius: 4px;
            cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; min-height: 40px; background: white; transition: border-color 0.2s;
        }
        .ms-display:hover, .ms-display.open { border-color: #409eff; }
        .ms-display .ms-placeholder { color: #909399; font-size: 14px; }
        .ms-display .ms-arrow { font-size: 12px; color: #606266; transition: transform 0.2s; flex-shrink: 0; }
        .ms-display.open .ms-arrow { transform: rotate(180deg); }
        .ms-tags { display: flex; flex-wrap: wrap; gap: 4px; flex: 1; }
        .ms-tag {
            display: inline-flex; align-items: center; background: #ecf5ff;
            color: #409eff; padding: 2px 8px; border-radius: 3px; font-size: 13px;
        }
        .ms-tag-remove { margin-left: 4px; cursor: pointer; font-weight: bold; line-height: 1; }
        .ms-tag-remove:hover { color: #f56c6c; }
        .ms-dropdown {
            display: none; position: absolute; top: calc(100% + 4px); left: 0; right: 0;
            max-height: 220px; overflow-y: auto; border: 1px solid #dcdfe6; border-radius: 4px;
            background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1000;
        }
        .ms-dropdown.open { display: block; }
        .ms-option {
            padding: 9px 12px; cursor: pointer; display: flex; align-items: center;
            gap: 8px; font-size: 14px; transition: background 0.15s;
        }
        .ms-option:hover { background: #f5f7fa; }
        .ms-option input[type="checkbox"] { cursor: pointer; width: 14px; height: 14px; }

        /* ç”˜ç‰¹å›¾ */
        .gantt-controls { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        .gantt-controls label { font-size: 14px; color: #606266; }
        .gantt-controls select { padding: 7px 28px 7px 10px; }
        .gantt-wrap { overflow-x: auto; }
        .gantt { min-width: 900px; }
        .gantt-header { display: flex; background: #f5f7fa; border-bottom: 2px solid #dcdfe6; }
        .gantt-col-name {
            width: 180px; flex-shrink: 0; padding: 10px 12px;
            font-weight: 600; font-size: 14px; color: #606266;
            cursor: pointer; user-select: none; display: flex; align-items: center; gap: 4px;
        }
        .gantt-col-name:hover { color: #409eff; }
        .gantt-col-leader {
            width: 100px; flex-shrink: 0; padding: 10px 12px;
            font-weight: 600; font-size: 14px; color: #606266;
            cursor: pointer; user-select: none; display: flex; align-items: center; gap: 4px;
        }
        .gantt-col-leader:hover { color: #409eff; }
        .gantt-col-client {
            width: 110px; flex-shrink: 0; padding: 10px 12px;
            font-weight: 600; font-size: 14px; color: #606266;
            cursor: pointer; user-select: none; display: flex; align-items: center; gap: 4px;
        }
        .gantt-col-client:hover { color: #409eff; }
        .gantt-col-name .sort-icon, .gantt-col-leader .sort-icon, .gantt-col-client .sort-icon { font-size: 12px; color: #c0c4cc; }
        .gantt-col-name.sorted .sort-icon, .gantt-col-leader.sorted .sort-icon, .gantt-col-client.sorted .sort-icon { color: #409eff; }
        .gantt-months { flex: 1; display: flex; }
        .gantt-month {
            flex: 1; text-align: center; padding: 10px 4px;
            font-size: 12px; color: #606266; border-left: 1px solid #e0e6ed;
        }
        .gantt-row { display: flex; border-bottom: 1px solid #ebeef5; min-height: 46px; align-items: center; }
        .gantt-row:hover { background: #fafbfc; }
        .gantt-cell-name {
            width: 180px; flex-shrink: 0; padding: 8px 12px;
            font-size: 14px; color: #303133;
        }
        .gantt-cell-leader {
            width: 100px; flex-shrink: 0; padding: 8px 12px;
            font-size: 13px; color: #606266;
        }
        .gantt-cell-client {
            width: 110px; flex-shrink: 0; padding: 8px 12px;
            font-size: 13px; color: #606266;
        }
        .gantt-bars { flex: 1; position: relative; height: 46px; }
        .gantt-bar {
            position: absolute; height: 28px; border-radius: 4px; top: 9px;
            padding: 0 8px; display: flex; align-items: center;
            font-size: 12px; color: white; cursor: pointer;
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
            transition: opacity 0.2s; min-width: 4px;
        }
        .gantt-bar:hover { opacity: 0.82; }
        .bar-executing { background: #67c23a; }
        .bar-high { background: #e6a23c; }
        .bar-low { background: #909399; }

        /* å¯ç”¨æ€§ */
        .avail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; margin-top: 16px; }
        .person-card { border: 1px solid #e0e6ed; border-radius: 6px; padding: 14px; }
        .person-card.available { border-color: #67c23a; background: #f0f9eb; }
        .person-card.busy { border-color: #f56c6c; background: #fef0f0; }
        .person-name { font-weight: 600; font-size: 15px; margin-bottom: 6px; }
        .person-status { font-size: 13px; margin-bottom: 6px; }
        .person-projects { font-size: 12px; color: #909399; }

        /* å›¾ä¾‹ */
        .legend { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: #606266; }
        .legend-dot { width: 12px; height: 12px; border-radius: 2px; }

        /* ç©ºçŠ¶æ€ */
        .empty { text-align: center; padding: 50px 20px; color: #909399; }
        .empty-icon { font-size: 48px; margin-bottom: 12px; }

        /* ç­›é€‰æ  */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; }
        .filter-bar label { font-size: 14px; color: #606266; }
        .filter-bar select { padding: 7px 28px 7px 10px; }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“Š é¡¹ç›®ä¸äººå‘˜ç®¡ç†ç³»ç»Ÿ</h1>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('add', this)">â• æ·»åŠ é¡¹ç›®</button>
        <button class="tab" onclick="switchTab('list', this)">ğŸ“‹ é¡¹ç›®åˆ—è¡¨</button>
        <button class="tab" onclick="switchTab('gantt', this)">ğŸ“ˆ ç”˜ç‰¹å›¾</button>
        <button class="tab" onclick="switchTab('avail', this)">ğŸ‘¥ äººå‘˜å¯ç”¨æ€§</button>
        <button class="tab" onclick="switchTab('members', this)">ğŸ‘¤ å›¢é˜Ÿæˆå‘˜</button>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘é¡¹ç›® -->
    <div id="tab-add" class="tab-content active">
        <div class="card">
            <div class="card-title" id="formTitle">æ–°å»ºé¡¹ç›®</div>
            <form id="projectForm">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>é¡¹ç›®åç§° *</label>
                        <input type="text" id="fName" required placeholder="è¾“å…¥é¡¹ç›®åç§°">
                    </div>
                    <div class="form-group">
                        <label>é¡¹ç›®å·</label>
                        <input type="text" id="fNumber" placeholder="å¦‚ï¼šPRJ-2024-001">
                    </div>
                    <div class="form-group">
                        <label>é¡¹ç›®å®¢æˆ· *</label>
                        <input type="text" id="fClient" required placeholder="è¾“å…¥å®¢æˆ·åç§°">
                    </div>
                    <div class="form-group">
                        <label>é¡¹ç›®çŠ¶æ€ *</label>
                        <select id="fStatus" required>
                            <option value="executing">å·²æœ‰åˆåŒæ­£æ‰§è¡Œä¸­</option>
                            <option value="high">å¯èƒ½æ€§å¤§çš„é¡¹ç›®</option>
                            <option value="low">æœ‰å¯èƒ½æˆ–å¯èƒ½æ€§å°çš„é¡¹ç›®</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å¼€å§‹æ—¶é—´ *</label>
                        <input type="date" id="fStart" required>
                    </div>
                    <div class="form-group">
                        <label>ç»“æŸæ—¶é—´ *</label>
                        <input type="date" id="fEnd" required>
                    </div>
                    <div class="form-group">
                        <label>é¡¹ç›®è´Ÿè´£äºº *</label>
                        <select id="fLeader" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é¡¹ç›®å‚ä¸äºº</label>
                        <div class="multiselect" id="msWrap">
                            <div class="ms-display" id="msDisplay">
                                <span class="ms-placeholder">è¯·é€‰æ‹©å‚ä¸äººå‘˜</span>
                                <span class="ms-arrow">â–¼</span>
                            </div>
                            <div class="ms-dropdown" id="msDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group full">
                        <label>å…¶ä»–å¤‡æ³¨</label>
                        <textarea id="fNotes" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."></textarea>
                    </div>
                </div>
                <div style="display:flex;gap:10px;">
                    <button type="submit" class="btn btn-primary" id="submitBtn">ä¿å­˜é¡¹ç›®</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEdit()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- é¡¹ç›®åˆ—è¡¨ -->
    <div id="tab-list" class="tab-content">
        <div class="card">
            <div class="card-title">é¡¹ç›®åˆ—è¡¨</div>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:#67c23a"></div>å·²æœ‰åˆåŒæ­£æ‰§è¡Œä¸­</div>
                <div class="legend-item"><div class="legend-dot" style="background:#e6a23c"></div>å¯èƒ½æ€§å¤§çš„é¡¹ç›®</div>
                <div class="legend-item"><div class="legend-dot" style="background:#909399"></div>æœ‰å¯èƒ½æˆ–å¯èƒ½æ€§å°çš„é¡¹ç›®</div>
            </div>
            <div class="table-wrap" id="projectsList"></div>
        </div>
    </div>

    <!-- ç”˜ç‰¹å›¾ -->
    <div id="tab-gantt" class="tab-content">
        <div class="card">
            <div class="card-title">é¡¹ç›®æ—¶é—´çº¿</div>
            <div class="gantt-controls">
                <label>çŠ¶æ€ç­›é€‰ï¼š</label>
                <select id="ganttFilter" onchange="renderGantt()">
                    <option value="all">å…¨éƒ¨é¡¹ç›®</option>
                    <option value="executing">å·²æœ‰åˆåŒæ­£æ‰§è¡Œä¸­</option>
                    <option value="high">å¯èƒ½æ€§å¤§çš„é¡¹ç›®</option>
                    <option value="low">æœ‰å¯èƒ½æˆ–å¯èƒ½æ€§å°çš„é¡¹ç›®</option>
                </select>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:#67c23a"></div>æ‰§è¡Œä¸­</div>
                <div class="legend-item"><div class="legend-dot" style="background:#e6a23c"></div>å¯èƒ½æ€§å¤§</div>
                <div class="legend-item"><div class="legend-dot" style="background:#909399"></div>å¯èƒ½æ€§å°</div>
                <span style="font-size:13px;color:#909399;margin-left:8px;">ç‚¹å‡»ã€Œé¡¹ç›®åç§°ã€æˆ–ã€Œè´Ÿè´£äººã€åˆ—æ ‡é¢˜å¯æ’åº</span>
            </div>
            <div class="gantt-wrap" id="ganttWrap"></div>
        </div>
    </div>

    <!-- äººå‘˜å¯ç”¨æ€§ -->
    <div id="tab-avail" class="tab-content">
        <div class="card">
            <div class="card-title">äººå‘˜å¯ç”¨æ€§åˆ†æ</div>
            <div class="filter-bar">
                <label>æŸ¥è¯¢æ—¶æ®µï¼š</label>
                <input type="date" id="availStart" style="padding:7px 10px;">
                <span style="color:#606266;">è‡³</span>
                <input type="date" id="availEnd" style="padding:7px 10px;">
                <button class="btn btn-primary" onclick="checkAvail()">æŸ¥è¯¢</button>
            </div>
            <div id="availResult"></div>
        </div>
    </div>

    <!-- å›¢é˜Ÿæˆå‘˜ -->
    <div id="tab-members" class="tab-content">
        <div class="card">
            <div class="card-title">å›¢é˜Ÿæˆå‘˜ç®¡ç†</div>
            <div style="margin-bottom:24px;">
                <div style="font-size:14px;font-weight:500;color:#606266;margin-bottom:10px;">æ·»åŠ æ–°æˆå‘˜</div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <input type="text" id="newMemberName" placeholder="è¾“å…¥æˆå‘˜å§“å" style="max-width:260px;flex:1;">
                    <button class="btn btn-primary" onclick="addMember()">æ·»åŠ æˆå‘˜</button>
                </div>
            </div>
            <div style="font-size:14px;font-weight:500;color:#606266;margin-bottom:10px;">å½“å‰æˆå‘˜</div>
            <div id="membersList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;"></div>
        </div>
    </div>
</div>

<script>
const API = window.location.origin;

let projects = [];
let members = [];
let selectedParticipants = [];

// åˆ—è¡¨æ’åºçŠ¶æ€
let listSort = { field: 'createdAt', dir: 'desc' };
// ç”˜ç‰¹å›¾æ’åºçŠ¶æ€
let ganttSort = { field: 'startDate', dir: 'asc' };

// â”€â”€ åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function init() {
    await loadMembers();
    await loadProjects();
    setDefaultDates();
    initMultiselect();
}

function switchTab(name, btn) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    if (btn) btn.classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
    if (name === 'gantt') renderGantt();
    if (name === 'list') renderList();
}

function setDefaultDates() {
    const today = new Date();
    const next = new Date(today.getFullYear(), today.getMonth() + 1, today.getDate());
    document.getElementById('availStart').valueAsDate = today;
    document.getElementById('availEnd').valueAsDate = next;
}

// â”€â”€ API è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function apiFetch(url, options = {}) {
    const res = await fetch(API + url, {
        headers: { 'Content-Type': 'application/json' },
        ...options
    });
    if (!res.ok) {
        const err = await res.json().catch(() => ({ error: res.statusText }));
        throw new Error(err.error || res.statusText);
    }
    return res.json();
}

// â”€â”€ å›¢é˜Ÿæˆå‘˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadMembers() {
    members = await apiFetch('/api/team-members');

    const sel = document.getElementById('fLeader');
    sel.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
    members.forEach(m => {
        const o = document.createElement('option');
        o.value = o.textContent = m;
        sel.appendChild(o);
    });

    renderMembersList();
    rebuildDropdown();
}

function renderMembersList() {
    const el = document.getElementById('membersList');
    if (!el) return;
    el.innerHTML = members.map(m => `
        <div style="background:#f5f7fa;padding:10px 14px;border-radius:6px;font-size:14px;">ğŸ‘¤ ${m}</div>
    `).join('');
}

async function addMember() {
    const input = document.getElementById('newMemberName');
    const name = input.value.trim();
    if (!name) return alert('è¯·è¾“å…¥æˆå‘˜å§“å');
    try {
        await apiFetch('/api/team-members', { method: 'POST', body: JSON.stringify({ name }) });
        input.value = '';
        await loadMembers();
    } catch (e) {
        alert(e.message);
    }
}

// â”€â”€ é¡¹ç›®åˆ—è¡¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadProjects() {
    projects = await apiFetch('/api/projects');
    renderList();
}

const statusText = { executing: 'å·²æœ‰åˆåŒæ­£æ‰§è¡Œä¸­', high: 'å¯èƒ½æ€§å¤§çš„é¡¹ç›®', low: 'æœ‰å¯èƒ½æˆ–å¯èƒ½æ€§å°çš„é¡¹ç›®' };
const statusOrder = { executing: 1, high: 2, low: 3 };

function sortedProjects(data) {
    const { field, dir } = listSort;
    return [...data].sort((a, b) => {
        let av, bv;
        if (field === 'status') { av = statusOrder[a.status]; bv = statusOrder[b.status]; }
        else if (field === 'startDate' || field === 'endDate') { av = new Date(a[field]); bv = new Date(b[field]); }
        else { av = (a[field] || '').toLowerCase(); bv = (b[field] || '').toLowerCase(); }
        if (av < bv) return dir === 'asc' ? -1 : 1;
        if (av > bv) return dir === 'asc' ? 1 : -1;
        return 0;
    });
}

function sortList(field) {
    if (listSort.field === field) {
        listSort.dir = listSort.dir === 'asc' ? 'desc' : 'asc';
    } else {
        listSort.field = field;
        listSort.dir = 'asc';
    }
    renderList();
}

function sortIcon(field) {
    if (listSort.field !== field) return '<span class="sort-icon">â‡…</span>';
    return `<span class="sort-icon">${listSort.dir === 'asc' ? 'â†‘' : 'â†“'}</span>`;
}

function thClass(field) {
    return listSort.field === field ? 'sortable sort-' + listSort.dir : 'sortable';
}

function renderList() {
    const el = document.getElementById('projectsList');
    if (!projects.length) {
        el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“­</div><div>æš‚æ— é¡¹ç›®ï¼Œè¯·å…ˆæ·»åŠ </div></div>';
        return;
    }
    const rows = sortedProjects(projects).map(p => `
        <tr>
            <td><strong>${esc(p.name)}</strong></td>
            <td>${esc(p.projectNumber || '-')}</td>
            <td>${esc(p.client)}</td>
            <td><span class="badge badge-${p.status}">${statusText[p.status]}</span></td>
            <td style="white-space:nowrap;">${p.startDate} ~ ${p.endDate}</td>
            <td>${esc(p.leader)}</td>
            <td>${p.participants && p.participants.length ? p.participants.map(esc).join(', ') : '-'}</td>
            <td>${esc(p.notes || '-')}</td>
            <td style="white-space:nowrap;">${formatDate(p.updatedAt || p.createdAt)}</td>
            <td style="white-space:nowrap;">
                <button class="btn btn-edit" onclick="editProject(${p.id})">ç¼–è¾‘</button>
                <button class="btn btn-danger" onclick="deleteProject(${p.id})">åˆ é™¤</button>
            </td>
        </tr>
    `).join('');

    el.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th class="${thClass('name')}" onclick="sortList('name')">é¡¹ç›®åç§° ${sortIcon('name')}</th>
                    <th>é¡¹ç›®å·</th>
                    <th class="${thClass('client')}" onclick="sortList('client')">å®¢æˆ· ${sortIcon('client')}</th>
                    <th class="${thClass('status')}" onclick="sortList('status')">çŠ¶æ€ ${sortIcon('status')}</th>
                    <th class="${thClass('startDate')}" onclick="sortList('startDate')">æ—¶é—´ ${sortIcon('startDate')}</th>
                    <th class="${thClass('leader')}" onclick="sortList('leader')">è´Ÿè´£äºº ${sortIcon('leader')}</th>
                    <th>å‚ä¸äºº</th>
                    <th>å¤‡æ³¨</th>
                    <th class="${thClass('updatedAt')}" onclick="sortList('updatedAt')">æ›´æ–°æ—¥æœŸ ${sortIcon('updatedAt')}</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
}

// â”€â”€ ç¼–è¾‘é¡¹ç›® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function editProject(id) {
    const p = projects.find(x => x.id === id);
    if (!p) return;

    document.getElementById('editId').value = p.id;
    document.getElementById('fName').value = p.name;
    document.getElementById('fNumber').value = p.projectNumber || '';
    document.getElementById('fClient').value = p.client;
    document.getElementById('fStatus').value = p.status;
    document.getElementById('fStart').value = p.startDate;
    document.getElementById('fEnd').value = p.endDate;
    document.getElementById('fLeader').value = p.leader;
    document.getElementById('fNotes').value = p.notes || '';

    selectedParticipants = [...(p.participants || [])];
    syncCheckboxes();
    updateDisplay();

    document.getElementById('formTitle').textContent = 'ç¼–è¾‘é¡¹ç›®';
    document.getElementById('submitBtn').textContent = 'æ›´æ–°é¡¹ç›®';

    // åˆ‡æ¢åˆ°è¡¨å•é¡µ
    switchTab('add', document.querySelector('[onclick*="add"]'));
    window.scrollTo(0, 0);
}

function cancelEdit() {
    resetForm();
}

function resetForm() {
    document.getElementById('projectForm').reset();
    document.getElementById('editId').value = '';
    document.getElementById('formTitle').textContent = 'æ–°å»ºé¡¹ç›®';
    document.getElementById('submitBtn').textContent = 'ä¿å­˜é¡¹ç›®';
    selectedParticipants = [];
    syncCheckboxes();
    updateDisplay();
}

// â”€â”€ è¡¨å•æäº¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('projectForm').addEventListener('submit', async e => {
    e.preventDefault();
    const editId = document.getElementById('editId').value;
    const isEdit = !!editId;

    const data = {
        name: document.getElementById('fName').value,
        projectNumber: document.getElementById('fNumber').value,
        client: document.getElementById('fClient').value,
        status: document.getElementById('fStatus').value,
        startDate: document.getElementById('fStart').value,
        endDate: document.getElementById('fEnd').value,
        leader: document.getElementById('fLeader').value,
        participants: selectedParticipants,
        notes: document.getElementById('fNotes').value
    };

    try {
        if (isEdit) {
            await apiFetch('/api/projects/' + editId, { method: 'PUT', body: JSON.stringify(data) });
            alert('é¡¹ç›®æ›´æ–°æˆåŠŸï¼');
        } else {
            await apiFetch('/api/projects', { method: 'POST', body: JSON.stringify(data) });
            alert('é¡¹ç›®æ·»åŠ æˆåŠŸï¼');
        }
        resetForm();
        await loadProjects();
    } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
    }
});

// â”€â”€ åˆ é™¤é¡¹ç›® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function deleteProject(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ')) return;
    try {
        await apiFetch('/api/projects/' + id, { method: 'DELETE' });
        await loadProjects();
    } catch (e) {
        alert('åˆ é™¤å¤±è´¥ï¼š' + e.message);
    }
}

// â”€â”€ å¤šé€‰æ¡† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initMultiselect() {
    const display = document.getElementById('msDisplay');
    const dropdown = document.getElementById('msDropdown');

    display.addEventListener('click', e => {
        if (e.target.classList.contains('ms-tag-remove')) return;
        dropdown.classList.toggle('open');
        display.classList.toggle('open');
    });

    document.addEventListener('click', e => {
        const wrap = document.getElementById('msWrap');
        if (!wrap.contains(e.target)) {
            dropdown.classList.remove('open');
            display.classList.remove('open');
        }
    });
}

function rebuildDropdown() {
    const dropdown = document.getElementById('msDropdown');
    dropdown.innerHTML = '';
    members.forEach(m => {
        const div = document.createElement('div');
        div.className = 'ms-option';
        div.innerHTML = `<input type="checkbox" id="chk-${m}" value="${m}"><label for="chk-${m}" style="cursor:pointer;flex:1;">${esc(m)}</label>`;
        div.querySelector('input').addEventListener('change', ev => {
            if (ev.target.checked) {
                if (!selectedParticipants.includes(m)) selectedParticipants.push(m);
            } else {
                selectedParticipants = selectedParticipants.filter(x => x !== m);
            }
            updateDisplay();
        });
        dropdown.appendChild(div);
    });
}

function syncCheckboxes() {
    members.forEach(m => {
        const cb = document.getElementById('chk-' + m);
        if (cb) cb.checked = selectedParticipants.includes(m);
    });
}

function removeTag(name) {
    selectedParticipants = selectedParticipants.filter(x => x !== name);
    syncCheckboxes();
    updateDisplay();
}

function updateDisplay() {
    const display = document.getElementById('msDisplay');
    if (!selectedParticipants.length) {
        display.innerHTML = '<span class="ms-placeholder">è¯·é€‰æ‹©å‚ä¸äººå‘˜</span><span class="ms-arrow">â–¼</span>';
    } else {
        const tags = selectedParticipants.map(m =>
            `<span class="ms-tag">${esc(m)}<span class="ms-tag-remove" onclick="removeTag('${m}')">Ã—</span></span>`
        ).join('');
        display.innerHTML = `<div class="ms-tags">${tags}</div><span class="ms-arrow">â–¼</span>`;
    }
}

// â”€â”€ ç”˜ç‰¹å›¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function sortGantt(field) {
    if (ganttSort.field === field) {
        ganttSort.dir = ganttSort.dir === 'asc' ? 'desc' : 'asc';
    } else {
        ganttSort.field = field;
        ganttSort.dir = 'asc';
    }
    renderGantt();
}

function ganttSortIcon(field) {
    if (ganttSort.field !== field) return '<span class="sort-icon">â‡…</span>';
    return `<span class="sort-icon">${ganttSort.dir === 'asc' ? 'â†‘' : 'â†“'}</span>`;
}

function renderGantt() {
    const el = document.getElementById('ganttWrap');
    const filter = document.getElementById('ganttFilter')?.value || 'all';

    let data = filter === 'all' ? projects : projects.filter(p => p.status === filter);

    if (!data.length) {
        el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“Š</div><div>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„é¡¹ç›®</div></div>';
        return;
    }

    // æ’åº
    data = [...data].sort((a, b) => {
        let av, bv;
        if (ganttSort.field === 'leader') { av = a.leader.toLowerCase(); bv = b.leader.toLowerCase(); }
        else if (ganttSort.field === 'client') { av = a.client.toLowerCase(); bv = b.client.toLowerCase(); }
        else if (ganttSort.field === 'status') { av = statusOrder[a.status]; bv = statusOrder[b.status]; }
        else { av = new Date(a.startDate); bv = new Date(b.startDate); }
        if (av < bv) return ganttSort.dir === 'asc' ? -1 : 1;
        if (av > bv) return ganttSort.dir === 'asc' ? 1 : -1;
        return 0;
    });

    const allDates = data.flatMap(p => [new Date(p.startDate), new Date(p.endDate)]);
    const minDate = new Date(Math.min(...allDates));
    const maxDate = new Date(Math.max(...allDates));
    const totalDays = Math.max(1, (maxDate - minDate) / 86400000);

    const months = [];
    let cur = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
    while (cur <= maxDate) { months.push(new Date(cur)); cur.setMonth(cur.getMonth() + 1); }

    const nameSorted   = ganttSort.field === 'name';
    const leaderSorted = ganttSort.field === 'leader';
    const clientSorted = ganttSort.field === 'client';

    const rows = data.map(p => {
        const s = new Date(p.startDate), e = new Date(p.endDate);
        const left  = ((s - minDate) / 86400000 / totalDays * 100).toFixed(2);
        const width = Math.max(0.5, ((e - s) / 86400000 / totalDays * 100)).toFixed(2);
        return `
            <div class="gantt-row">
                <div class="gantt-cell-name">${esc(p.name)}</div>
                <div class="gantt-cell-leader">${esc(p.leader)}</div>
                <div class="gantt-cell-client">${esc(p.client)}</div>
                <div class="gantt-bars">
                    <div class="gantt-bar bar-${p.status}"
                         style="left:${left}%;width:${width}%"
                         title="${esc(p.name)}\n${p.startDate} â†’ ${p.endDate}\nè´Ÿè´£äºº: ${esc(p.leader)}\nå®¢æˆ·: ${esc(p.client)}">
                        ${esc(p.name)}
                    </div>
                </div>
            </div>`;
    }).join('');

    el.innerHTML = `
        <div class="gantt">
            <div class="gantt-header">
                <div class="gantt-col-name ${nameSorted ? 'sorted' : ''}" onclick="sortGantt('name')">
                    é¡¹ç›®åç§° ${ganttSortIcon('name')}
                </div>
                <div class="gantt-col-leader ${leaderSorted ? 'sorted' : ''}" onclick="sortGantt('leader')">
                    è´Ÿè´£äºº ${ganttSortIcon('leader')}
                </div>
                <div class="gantt-col-client ${clientSorted ? 'sorted' : ''}" onclick="sortGantt('client')">
                    å®¢æˆ· ${ganttSortIcon('client')}
                </div>
                <div class="gantt-months">
                    ${months.map(m => `<div class="gantt-month">${m.getFullYear()}å¹´${m.getMonth()+1}æœˆ</div>`).join('')}
                </div>
            </div>
            ${rows}
        </div>`;
}

// â”€â”€ äººå‘˜å¯ç”¨æ€§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function checkAvail() {
    const start = new Date(document.getElementById('availStart').value);
    const end   = new Date(document.getElementById('availEnd').value);
    if (!start || !end || isNaN(start) || isNaN(end)) return alert('è¯·é€‰æ‹©æŸ¥è¯¢æ—¶æ®µ');
    if (start > end) return alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');

    // busy[æˆå‘˜] = [ { name: é¡¹ç›®å, isPM: true/false } ]
    const busy = {};
    members.forEach(m => { busy[m] = []; });

    projects.forEach(p => {
        const ps = new Date(p.startDate), pe = new Date(p.endDate);
        if (ps <= end && pe >= start) {
            if (busy[p.leader] !== undefined) {
                busy[p.leader].push({ name: p.name, isPM: true });
            }
            (p.participants || []).forEach(m => {
                if (busy[m] !== undefined && m !== p.leader) {
                    busy[m].push({ name: p.name, isPM: false });
                }
            });
        }
    });

    const avail    = members.filter(m => !busy[m].length);
    const busyList = members.filter(m =>  busy[m].length);

    const projectTag = item =>
        item.isPM
            ? `${esc(item.name)}<span style="background:#409eff;color:white;font-size:11px;padding:1px 5px;border-radius:3px;margin-left:4px;font-weight:600;">PM</span>`
            : esc(item.name);

    document.getElementById('availResult').innerHTML = `
        <div style="margin-bottom:20px;">
            <div style="color:#67c23a;font-weight:600;margin-bottom:10px;font-size:15px;">âœ“ å¯ç”¨äººå‘˜ï¼ˆ${avail.length}äººï¼‰</div>
            <div class="avail-grid">
                ${avail.map(m => `
                    <div class="person-card available">
                        <div class="person-name">ğŸ‘¤ ${esc(m)}</div>
                        <div class="person-status" style="color:#67c23a;">å½“å‰å¯ç”¨</div>
                    </div>`).join('') || '<div style="color:#909399">æ— </div>'}
            </div>
        </div>
        <div>
            <div style="color:#f56c6c;font-weight:600;margin-bottom:10px;font-size:15px;">âœ— å¿™ç¢Œäººå‘˜ï¼ˆ${busyList.length}äººï¼‰</div>
            <div class="avail-grid">
                ${busyList.map(m => `
                    <div class="person-card busy">
                        <div class="person-name">ğŸ‘¤ ${esc(m)}</div>
                        <div class="person-status" style="color:#f56c6c;">å‚ä¸é¡¹ç›®ä¸­</div>
                        <div class="person-projects">
                            ${busy[m].map(item => `<div style="margin-top:4px;">ğŸ“‹ ${projectTag(item)}</div>`).join('')}
                        </div>
                    </div>`).join('') || '<div style="color:#909399">æ— </div>'}
            </div>
        </div>`;
}

// â”€â”€ å·¥å…·å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function esc(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatDate(str) {
    if (!str) return '-';
    const d = new Date(str);
    if (isNaN(d)) return '-';
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// â”€â”€ å¯åŠ¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
